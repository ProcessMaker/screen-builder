<template>
  <b-row class="h-100 m-0">
    <!-- Controls -->
    <b-col class="overflow-hidden h-100 p-0 controls-column">
      <b-card
        no-body
        class="h-100 rounded-0 border-top-0 border-bottom-0 border-left-0"
      >
        <b-input-group size="sm">
          <b-input-group-prepend>
            <b-input-group-text
              class="filter-icon border-left-0 border-top-0 rounded-0"
            >
              <i class="fas fa-filter" />
            </b-input-group-text>
          </b-input-group-prepend>

          <b-form-input
            v-model="filterQuery"
            class="border-top-0 border-right-0 rounded-0"
            type="text"
            :placeholder="$t('Filter Controls')"
          />
        </b-input-group>

        <b-card-body no-body class="p-0 overflow-auto">
          <draggable
            v-if="renderControls"
            id="controls"
            v-model="filteredControls"
            data-cy="controls"
            v-bind="{
              sort: false,
              group: { name: 'controls', pull: 'clone', put: false }
            }"
            :clone="cloneControl"
            class="controls list-group w-auto list-group-flush"
          >
            <b-list-group-item
              v-for="(element, index) in filteredControls"
              :key="index"
              :data-cy="'controls-' + element.component"
              :class="{ 'ai-control': element.component === 'AiSection'}"
            >
              <i v-if="element.config.icon" :class="element.config.icon" />
              <span v-html="element.config.svg" class="svg-icon"></span>
              {{ $t(element.label) }}
            </b-list-group-item>

            <li v-if="!filteredControls.length" class="list-group-item">
              <slot />
            </li>
          </draggable>
        </b-card-body>
      </b-card>
    </b-col>

    <!-- Renderer -->
    <b-col
      id="screen-container"
      class="overflow-auto mh-100 p-0 px-4 d-flex flex-column position-relative pt-2"
    >
      <b-input-group size="sm" class="bg-white mt-3">
        <b-form-select
          v-if="showToolbar"
          v-model="currentPage"
          class="form-control"
          data-cy="toolbar-page"
        >
          <option v-for="(data, page) in config" :key="page" :value="page">
            {{ data.name }}
          </option>
        </b-form-select>

        <div v-if="showToolbar">
          <b-button
            size="sm"
            variant="secondary"
            class="ml-1"
            :title="$t('Edit Page Title')"
            data-cy="toolbar-edit"
            @click="openEditPageModal(currentPage)"
          >
            <i class="far fa-edit" />
          </b-button>

          <b-button
            size="sm"
            variant="danger"
            class="ml-1"
            :title="$t('Delete Page')"
            :disabled="!displayDelete"
            data-cy="toolbar-remove"
            @click="confirmDelete()"
          >
            <i class="far fa-trash-alt" />
          </b-button>

          <b-button
            v-b-modal.addPageModal
            size="sm"
            variant="secondary"
            class="ml-1 mr-1"
            :title="$t('Add New Page')"
            data-cy="toolbar-add"
            @click="originalPageName = null"
          >
            <i class="fas fa-plus" />
          </b-button>
        </div>

        <b-button-group size="sm" class="ml-1 ml-auto">
          <b-button :disabled="!canUndo" data-cy="toolbar-undo" @click="undo">{{
            $t("Undo")
          }}</b-button>
          <b-button :disabled="!canRedo" data-cy="toolbar-redo" @click="redo">{{
            $t("Redo")
          }}</b-button>
        </b-button-group>

        <hr class="w-100" />
      </b-input-group>

      <div
        v-if="isCurrentPageEmpty"
        data-cy="screen-drop-zone"
        class="d-flex justify-content-center align-items-center drag-placeholder text-center position-absolute rounded mt-4 flex-column"
      >
        <span class="mb-3" v-html="dragElementIcon"></span>
        <h3>{{ $t("Place your controls here.") }}</h3>
        <p>
          {{ $t("To begin creating a screen, drag and drop items from the Controls Menu on the left.") }}
        </p>
        <!-- {{ $t("Drag an element here") }} -->
      </div>

      <draggable
        v-if="renderControls"
        :key="editorContentKey"
        data-cy="editor-content"
        class="h-100"
        ghost-class="form-control-ghost"
        :value="config[currentPage].items"
        v-bind="{
          group: { name: 'controls' },
          swapThreshold: 0.5
        }"
        @input="updateConfig"
      >
        <div
          v-for="(element, index) in config[currentPage].items"
          :key="index"
          class="control-item mt-4 mb-4"
          :class="{
            selected: selected === element,
            hasError: hasError(element)
          }"
          :selector="element.config.customCssSelector"
          @click="inspect(element)"
        >
          <div
            v-if="element.container"
            class="card container-lement"
            :class="{ 'ai-section-card': isAiSection(element) }"
            data-cy="screen-element-container"
            @click="inspect(element)"
          >
            <div
              v-if="selected === element"
              class="card-header form-element-header d-flex align-items-center"
              :class="{ 'pulse': isAiSection(element) && aiPreview(element) }"
            >
              <i class="fas fa-arrows-alt-v mr-1 text-muted" />
              <i
                v-if="element.config.icon"
                :class="element.config.icon"
                class="mr-2 ml-1"
              />
              <span
                v-if="element.config.svg"
                v-html="element.config.svg"
                class="svg-icon mr-2 ml-1"
              ></span>
              {{ element.config.name || element.label || $t("Field Name") }}
              <div class="ml-auto">
                <button
                  v-if="isAiSection(element) && aiPreview(element)"
                  class="btn btn-sm btn-primary mr-2"
                  :title="$t('Apply Changes')"
                  @click="applyAiChanges(element)"
                >
                  {{ $t("Apply Changes") }}
                </button>
                <button
                v-if="!(isAiSection(element) && aiPreview(element))"
                  class="btn btn-sm btn-secondary mr-2"
                  :title="$t('Copy Control')"
                  @click="duplicateItem(index)"
                >
                  <i class="fas fa-copy text-light" />
                </button>
                <button
                  class="btn btn-sm btn-danger"
                  :title="$t('Delete Control')"
                  @click="deleteItem(index)"
                >
                  <i class="far fa-trash-alt text-light" />
                </button>
              </div>
            </div>
            <component
              :is="element['editor-component']"
              v-model="element.items"
              :validation-errors="validationErrors"
              class="card-body"
              :class="elementCssClass(element)"
              :selected="selected"
              :config="element.config"
              :ai-element="element"
              @inspect="inspect"
              @update-state="updateState"
            />
          </div>

          <div v-else class="card" data-cy="screen-element-container">
            <div
              v-if="selected === element"
              class="card-header form-element-header d-flex align-items-center"
            >
              <i class="fas fa-arrows-alt-v mr-1 text-muted" />
              <i
                v-if="element.config.icon"
                :class="element.config.icon"
                class="mr-2 ml-1"
              />
              {{ element.config.name || $t("Variable Name") }}
              <div class="ml-auto">
                <button
                  class="btn btn-sm btn-secondary mr-2"
                  :title="$t('Copy Control')"
                  @click="duplicateItem(index)"
                >
                  <i class="fas fa-copy text-light" />
                </button>
                <button
                  class="btn btn-sm btn-danger"
                  :title="$t('Delete Control')"
                  @click="deleteItem(index)"
                >
                  <i class="far fa-trash-alt text-light" />
                </button>
              </div>
            </div>
            <component
              v-bind="element.config"
              :is="element['editor-component']"
              :tabindex="element.config.interactive ? 0 : -1"
              class="card-body m-0 pb-4 pt-4"
              :class="[
                elementCssClass(element),
                { 'prevent-interaction': !element.config.interactive }
              ]"
              @input="
                element.config.interactive
                  ? (element.config.content = $event)
                  : null
              "
              @focusout.native="updateState"
            />
          </div>
        </div>
      </draggable>
    </b-col>

    <!-- Inspector -->
    <b-col
      v-if="renderControls"
      class="overflow-hidden h-100 p-0 inspector-column"
    >
      <b-card
        no-body
        class="p-0 h-100 border-top-0 border-bottom-0 border-right-0 rounded-0"
      >
        <b-card-body class="p-0 h-100 overflow-auto">
          <template v-for="accordion in accordions">
            <b-button
              v-if="getInspectorFields(accordion).length > 0"
              :key="`${accordionName(accordion)}-button`"
              variant="outline"
              class="text-left card-header d-flex align-items-center w-100 outline-0 text-capitalize shadow-none"
              :data-cy="`accordion-${accordionName(accordion).replace(
                ' ',
                ''
              )}`"
              :accordion-name="`accordion-${accordionName(accordion).replace(
                ' ',
                ''
              )}`"
              :is-open="accordion.open ? '1' : '0'"
              @click="toggleAccordion(accordion)"
            >
              <i class="fas fa-cog mr-2" />
              {{ $t(accordionName(accordion)) }}
              <i
                class="fas fa-angle-down ml-auto"
                :class="{ 'fas fa-angle-right': !accordion.open }"
              />
            </b-button>
            <b-collapse
              :id="accordionName(accordion)"
              :key="`${accordionName(accordion)}-collapse`"
              v-model="accordion.open"
            >
              <component
                :is="item.type"
                v-for="(item, index) in getInspectorFields(accordion)"
                :key="index"
                v-model="inspection.config[item.field]"
                :data-cy="'inspector-' + (item.field || item.config.name)"
                v-bind="item.config"
                :field-name="item.field"
                :field-accordion="`accordion-${accordionName(accordion).replace(
                  ' ',
                  ''
                )}`"
                :builder="builder"
                :form-config="config"
                :screen-type="screenType"
                :current-page="currentPage"
                :selected-control="selected"
                class="border-bottom m-0 p-4"
                @focusout.native="updateState"
                @update-state="updateState"
                @setName="inspection.config.name = $event"
              />
            </b-collapse>
          </template>
        </b-card-body>
      </b-card>
    </b-col>

    <!-- Modals -->
    <b-modal
      id="addPageModal"
      :ok-title="$t('Save')"
      :cancel-title="$t('Cancel')"
      cancel-variant="btn btn-outline-secondary"
      ok-variant="btn btn-secondary ml-2"
      :title="$t('Add New Page')"
      header-close-content="&times;"
      data-cy="add-page-modal"
      @ok="addPage"
    >
      <required />
      <form-input
        ref="addPageInput"
        v-model="addPageName"
        :name="$t('Page Name')"
        :label="$t('Page Name') + ' *'"
        :helper="$t('The name of the new page to add')"
        validation="unique-page-name|required"
        data-cy="add-page-name"
        required
        aria-required="true"
      />
    </b-modal>

    <b-modal
      ref="editPageModal"
      :title="$t('Edit Page Title')"
      :ok-title="$t('Save')"
      :cancel-title="$t('Cancel')"
      cancel-variant="btn btn-outline-secondary"
      ok-variant="btn btn-secondary ml-2"
      header-close-content="&times;"
      @ok="editPage"
    >
      <required />
      <form-input
        ref="editPageInput"
        v-model="editPageName"
        :name="$t('Page Name')"
        :label="$t('Page Name') + ' *'"
        :helper="$t('The new name of the page')"
        validation="unique-page-name|required"
        required
        aria-required="true"
      />
    </b-modal>

    <b-modal
      ref="confirm"
      :title="$t('Caution!')"
      :ok-title="$t('Delete')"
      :cancel-title="$t('Cancel')"
      cancel-variant="btn btn-outline-secondary"
      ok-variant="btn btn-secondary ml-2"
      header-close-content="&times;"
      @ok="deletePage"
      @cancel="hideConfirmModal"
    >
      <p>{{ confirmMessage }}</p>
      <div slot="modal-ok">{{ $t("Delete") }}</div>
    </b-modal>
  </b-row>
</template>

<script>
import draggable from "vuedraggable";
import _ from "lodash";
import {
  FormInput,
  FormSelectList,
  FormTextArea,
  FormCheckbox,
  FormDatePicker,
  FormHtmlEditor,
  FormHtmlViewer
} from "@processmaker/vue-form-elements";
import HasColorProperty from "../mixins/HasColorProperty";
import * as renderer from "./renderer";
import * as inspector from "./inspector";
import "@processmaker/vue-form-elements/dist/vue-form-elements.css";
import accordions from "./accordions";
import { keyNameProperty } from "../form-control-common-properties";
import VariableNameGenerator from "@/components/VariableNameGenerator";
import testing from "@/mixins/testing";
import defaultValueEditor from "./inspector/default-value-editor";
import RequiredCheckbox from "./utils/required-checkbox";
import MultipleUploadsCheckbox from "./utils/multiple-uploads-checkbox";
import { formTypes } from "@/global-properties";
import { getCancelledJobs } from './utils.js'

const Validator = require("validatorjs");
// To include another language in the Validator with variable processmaker
const globalObject = typeof window === "undefined" ? global : window;

if (
  globalObject.ProcessMaker &&
  globalObject.ProcessMaker.user &&
  globalObject.ProcessMaker.user.lang
) {
  Validator.useLang(globalObject.ProcessMaker.user.lang);
}

// Todo: Validation messages are not translated. These will need to be converted
// to Validator.registerAsync() in order to get the $t translator.
// Should also probably be converted to a mixin. These changes would then
// require modifications to to App.vue and PM4 Core implementations
Validator.register(
  "columns-adds-to-12",
  (value) => {
    const sum = value.reduce((total, options) => {
      return total + parseInt(options.content);
    }, 0);

    if (sum === 12) {
      return true;
    }
    return false;
  },
  "Columns must add to 12"
);

const defaultConfig = [
  {
    name: "Default",
    items: []
  }
];

export default {
  components: {
    draggable,
    FormInput,
    FormSelectList,
    FormCheckbox,
    FormTextArea,
    FormDatePicker,
    FormHtmlEditor,
    FormHtmlViewer,
    RequiredCheckbox,
    MultipleUploadsCheckbox,
    defaultValueEditor,
    ...inspector,
    ...renderer,
  },
  mixins: [HasColorProperty, testing],
  props: {
    renderControls: {
      type: Boolean,
      default: true
    },
    validationErrors: {
      type: Array
    },
    initialConfig: {
      type: Array
    },
    title: {
      type: String
    },
    screenType: {
      type: String,
      default: formTypes.form
    },
    screen: {
      type: Object
    },
    processId: {
      default: 0,
    },
  },
  data() {
    const config = this.initialConfig || defaultConfig;
    this.migrateConfig(config);
    const generator = new VariableNameGenerator();
    const variables = generator.GetVariableNames(config);

    if (this.title && config[0].name === "Default") {
      config[0].name = this.title;
    }

    return {
      dragElementIcon: `<svg width="81" height="107" viewBox="0 0 81 107" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M47.125 28.6562V0.5H5.71875C2.96523 0.5 0.75 2.71523 0.75 5.46875V101.531C0.75 104.285 2.96523 106.5 5.71875 106.5H75.2812C78.0348 106.5 80.25 104.285 80.25 101.531V33.625H52.0938C49.3609 33.625 47.125 31.3891 47.125 28.6562ZM60.375 77.5156C60.375 78.882 59.257 80 57.8906 80H23.1094C21.743 80 20.625 78.882 20.625 77.5156V75.8594C20.625 74.493 21.743 73.375 23.1094 73.375H57.8906C59.257 73.375 60.375 74.493 60.375 75.8594V77.5156ZM60.375 64.2656C60.375 65.632 59.257 66.75 57.8906 66.75H23.1094C21.743 66.75 20.625 65.632 20.625 64.2656V62.6094C20.625 61.243 21.743 60.125 23.1094 60.125H57.8906C59.257 60.125 60.375 61.243 60.375 62.6094V64.2656ZM60.375 49.3594V51.0156C60.375 52.382 59.257 53.5 57.8906 53.5H23.1094C21.743 53.5 20.625 52.382 20.625 51.0156V49.3594C20.625 47.993 21.743 46.875 23.1094 46.875H57.8906C59.257 46.875 60.375 47.993 60.375 49.3594ZM80.25 25.7371V27H53.75V0.5H55.0129C56.3379 0.5 57.6008 1.01758 58.5324 1.94922L78.8008 22.2383C79.7324 23.1699 80.25 24.4328 80.25 25.7371Z" fill="#699CFF"/>
      </svg>`,
      currentPage: 0,
      selected: null,
      display: "editor",
      inspection: {},
      // Blank at start, assume the parent component will call addControl for each control
      controls: [],
      pageAddModal: false,
      addPageName: "",
      editPageIndex: null,
      editPageName: "",
      originalPageName: null,
      config,
      confirmMessage: "",
      pageDelete: 0,
      translated: [],
      showAssignment: false,
      showVariable: false,
      showDesign: false,
      filterQuery: "",
      accordions,
      variables,
      generator,
      variablesTree: [],
      language: "en",
      collator: null,
      editorContentKey: 0,
      cancelledJobs: []
    };
  },
  computed: {
    builder() {
      return this;
    },
    canUndo() {
      return this.$store.getters["undoRedoModule/canUndo"];
    },
    canRedo() {
      return this.$store.getters["undoRedoModule/canRedo"];
    },
    displayDelete() {
      return this.config.length > 1;
    },
    filteredControls() {
      const excludedLabels = ["Bootstrap Wrapper", "Bootstrap Component"];

      const filtered = this.controls.filter((control) => {
        return control.label.toLowerCase().includes(this.filterQuery.toLowerCase());
      });

      const excluded = filtered.filter((control) => {
        return excludedLabels.includes(control.label);
      });

      const included = filtered.filter((control) => {
        return !excludedLabels.includes(control.label);
      });

      const sorted = included.sort((a, b) => {
        return this.collator.compare(a.label, b.label);
      });

      return [...sorted, ...excluded].sort((a, b) => {
        const textA = a.label.toLowerCase();
        const textB = b.label.toLowerCase();
        if (textA < textB) {
          return -1;
        }
        return textA > textB ? 1 : 0;
      });
    },
    isCurrentPageEmpty() {
      return this.config[this.currentPage].items.length === 0;
    },
    showToolbar() {
      return this.screenType === formTypes.form;
    },
    
  },
  watch: {
    config: {
      handler() {
        this.checkForCaptchaInLoops();
        this.$emit("change", this.config);
      },
      deep: true
    },
    currentPage() {
      this.inspect();
    },
    inspection(e) {
      if (this.translated.includes(e)) {
        // already translated, don't translate again!
        return;
      }
      for (const i in e.inspector) {
        e.inspector[i].config.label = this.$t(e.inspector[i].config.label);
        e.inspector[i].config.helper = this.$t(e.inspector[i].config.helper);
        if (e.inspector[i].config.options) {
          for (const io in e.inspector[i].config.options) {
            e.inspector[i].config.options[io].content = this.$t(
              e.inspector[i].config.options[io].content
            );
          }
        }
      }
      this.translated.push(e);
    },
    controls() {
      if (
        this.processId !== 0 &&
        this.processId !== undefined &&
        !this.config[this.currentPage].items.length
      ) {
        this.addDefaultAiControl();
      }
    }
  },
  created() {
    Validator.register(
      "unique-page-name",
      (value) => {
        const pageNames = this.config
          .map((config) => config.name)
          .filter((name) => name !== this.originalPageName);
        return !pageNames.includes(value);
      },
      this.$t("Must be unique")
    );
    this.$store.dispatch("undoRedoModule/pushState", {
      config: JSON.stringify(this.config),
      currentPage: this.currentPage
    });
    this.initiateLanguageSupport();
  },
  mounted() {
    this.cancelledJobs = getCancelledJobs();

    this.checkForCaptchaInLoops();

    this.$root.$on("nested-screen-updated", () => {
      this.checkForCaptchaInLoops();
    });
    this.$root.$on("ai-form-generated", (formItems, nonce) => {
      this.previewAiChanges(formItems, nonce);
    });
    this.$root.$on("apply-ai-changes", (element) => {
      this.applyAiChanges(element);
    });
    this.$root.$on("ai-form-progress-updated", (progress, nonce) => {
      this.updateProgress(progress, nonce);
    });
  },
  methods: {
    refreshContent() {
      this.editorContentKey++;
    },
    checkForCaptchaInLoops() {
      this.config.forEach((page) => {
        this.checkForCaptcha(page.items);
      });
    },
    checkForCaptcha(items, insideLoop = false, nestedScreen = null) {
      items.forEach((item) => {
        if (!item.items && item.component == "Captcha" && insideLoop) {
          if (nestedScreen && nestedScreen.config.screen) {
            this.$root.$emit("remove-nested", nestedScreen.config.screen);
            nestedScreen.config.screen = null;
            globalObject.ProcessMaker.alert(
              this.$t(
                // eslint-disable-next-line max-len
                "You are trying to place a nested screen within CAPTCHA elements inside a loop. CAPTCHA controls cannot be placed within a Loop control."
              ),
              "danger"
            );
          } else {
            items.splice(items.indexOf(item), 1);
            globalObject.ProcessMaker.alert(
              this.$t(
                "CAPTCHA controls cannot be placed within a Loop control."
              ),
              "danger"
            );
          }
        }
        if (item.items) {
          this.checkForCaptcha(item.items, true, nestedScreen);
        }
        if (
          item.component === "FormNestedScreen" &&
          item.config.screen &&
          window.nestedScreens
        ) {
          const nestedScreenItems =
            window.nestedScreens[`id_${item.config.screen}`];
          if (nestedScreenItems) {
            nestedScreenItems.forEach((nestedScreenPage) => {
              this.checkForCaptcha(nestedScreenPage.items, insideLoop, item);
            });
          }
        }
      });
    },
    loadVariablesTree() {
      const definition = {
        config: this.$parent.config,
        computed: this.$parent.computed,
        customCSS: this.$parent.customCSS,
        watchers: this.$parent.watchers
      };
      this.variablesTree =
        this.$refs.treeOfVariables.getVariablesTree(definition);
      this.$refs.treeOfVariables.getVariablesTree({ config: [] });
    },
    accordionName(accordion) {
      return accordion.name instanceof Function
        ? accordion.name(this.inspection)
        : accordion.name;
    },
    toggleAccordion(accordion) {
      this.accordions.forEach((panel) => {
        if (panel !== accordion) {
          panel.open = false;
        }
      });
      accordion.open = !accordion.open;
    },
    openAccordion(accordion) {
      this.accordions.forEach((panel) => {
        panel.open = false;
      });
      accordion.open = true;
    },
    migrateConfig(config = this.config) {
      config.forEach((page) => this.replaceFormText(page.items));
      config.forEach((page) => this.migrateFormSubmit(page.items));
      config.forEach((page) => this.updateFieldNameValidation(page.items));
      config.forEach((page) =>
        this.removeDataVariableFromNestedScreens(page.items)
      );
    },
    updateFieldNameValidation(items) {
      items.forEach((item) => {
        if (item.inspector) {
          item.inspector.forEach((inspector) => {
            if (
              inspector.field === "name" &&
              "validation" in inspector.config &&
              inspector.config.name !== "DataVariable" &&
              item.component !== "FileUpload" &&
              item.component !== "FormButton"
            ) {
              inspector.config.validation = keyNameProperty.config.validation;
            }
          });
        }
        if (item.items instanceof Array) {
          this.replaceFormText(item.items);
        }
      });
    },
    removeDataVariableFromNestedScreens(items) {
      items.forEach((item) => {
        if (item.inspector) {
          const hasDataVariable = item.inspector.find(
            (inspector) => inspector.config.name === "DataVariable"
          );
          item.inspector = item.inspector.filter(
            (inspector) => inspector.config.name !== "DataVariable"
          );
          if (hasDataVariable) {
            delete item.config.name;
          }
        }
      });
    },
    replaceFormText(items) {
      items.forEach((item) => {
        if (item.component === "FormText") {
          item.component = "FormHtmlEditor";
          item["editor-component"] = "FormHtmlEditor";
          const style =
            (item.config.fontSize
              ? `font-size: ${item.config.fontSize};`
              : "") +
            (item.config.fontWeight
              ? `font-weight: ${item.config.fontWeight};`
              : "") +
            (item.config.textAlign
              ? `text-align: ${item.config.textAlign};`
              : "");
          item.config = {
            content:
              "<div style=\"" + style + "\">" + item.config.label + "</div>",
            interactive: true
          };
        }
        if (item.items instanceof Array) {
          this.replaceFormText(item.items);
        }
      });
    },
    migrateFormSubmit(items) {
      items.forEach((item) => {
        if (item["editor-control"] !== "FormSubmit") {
          item["editor-control"] = item["editor-component"];
        }

        if (item.config.event === "submit") {
          if (item["editor-component"] === "FormNestedScreen") {
            // Old nested screens erroneously had an event key. Remove it here
            // and set the editor-control back to FormNestedScreen.
            delete item.config.event;
            item["editor-control"] = "FormNestedScreen";
            item.config.name = "Nested Screen";
          } else if (item["editor-control"] !== "FormImage") {
            item["editor-control"] = "FormSubmit";
          }
        }
        if (item.config.event === "pageNavigate") {
          item["editor-control"] = "PageNavigation";
        }
        if (
          item.items instanceof Array &&
          item.component === "FormMultiColumn"
        ) {
          item["editor-control"] = "FormMultiColumn";
          item.items.forEach((column) => this.migrateFormSubmit(column));
        }
      });
    },
    getAllAccordionizedFields() {
      if (this._allAccordionizedFields) {
        return this._allAccordionizedFields;
      }
      this._allAccordionizedFields = this.accordions.flatMap((accordion) => {
        return accordion.fields.map((fieldName) => {
          if (typeof fieldName === "string") {
            return fieldName;
          }
          return fieldName.name;
        });
      });
      return this._allAccordionizedFields;
    },
    knownField(field) {
      return this.getAllAccordionizedFields().includes(field);
    },
    getInspectorFields(accordion) {
      if (!this.inspection.inspector) {
        return [];
      }

      const accordionFields = accordion.fields
        .filter((field) => {
          if (typeof field !== "string") {
            const { component } = this.inspection;
            const { showFor, hideFor } = field;

            if (showFor) {
              return showFor === component;
            }

            if (hideFor) {
              return hideFor !== component;
            }
          }

          return true;
        })
        .map((field) => {
          if (typeof field !== "string") {
            return field.name;
          }

          return field;
        });
      const control = this.controls.find(
        (control) =>
          control["editor-control"] === this.inspection["editor-control"]
      ) ||
        this.controls.find(
          (control) => control.component === this.inspection.component
        ) || { inspector: [] };
      return control.inspector.filter((input) => {
        if (accordionFields.includes(input.field)) {
          return true;
        }
        if (
          !this.knownField(input.field) &&
          accordion.name === "Configuration"
        ) {
          // If it's not a known inspector field from accordion.js and this is the
          // configuration accordion, then add it here
          return true;
        }
        return false;
      });
    },
    updateState() {
      this.$store.dispatch("undoRedoModule/pushState", {
        config: JSON.stringify(this.config),
        currentPage: this.currentPage
      });
    },
    undo() {
      this.inspect();
      this.$store.dispatch("undoRedoModule/undo");
      this.config = JSON.parse(
        this.$store.getters["undoRedoModule/currentState"].config
      );
      this.currentPage = JSON.parse(
        this.$store.getters["undoRedoModule/currentState"].currentPage
      );
    },
    redo() {
      this.inspect();
      this.$store.dispatch("undoRedoModule/redo");
      this.config = JSON.parse(
        this.$store.getters["undoRedoModule/currentState"].config
      );
      this.currentPage = JSON.parse(
        this.$store.getters["undoRedoModule/currentState"].currentPage
      );
    },
    updateConfig(items) {
      this.config[this.currentPage].items = items;
      this.updateState();
    },
    hasError(element) {
      return this.validationErrors.some(({ item }) => item === element);
    },
    focusInspector(validation) {
      this.showConfiguration = true;
      this.currentPage = this.config.indexOf(validation.page);
      this.$nextTick(() => {
        this.inspect(validation.item);
        this.$nextTick(() => {
          const field = this.$el.querySelector(
            `[field-name="${validation.field}"]`
          );
          if (field) {
            const accordion = this.$el.querySelector(
              `[accordion-name="${field.getAttribute("field-accordion")}"]`
            );
            accordion &&
              accordion.getAttribute("is-open") === "0" &&
              accordion.click();
            field.focus instanceof Function && field.focus();
          }
        });
      });
    },
    confirmDelete() {
      this.confirmMessage = this.$t(
        "Are you sure you want to delete {{item}}?",
        { item: this.config[this.currentPage].name }
      );
      this.pageDelete = this.currentPage;
      this.$refs.confirm.show();
    },
    hideConfirmModal() {
      this.$refs.confirm.hide();
    },
    addControl(control) {
      this.controls.push(control);
    },
    deleteItem(index) {
      // Remove the item from the array in currentPage
      this.config[this.currentPage].items.splice(index, 1);
      this.inspection.inspector.splice(0, this.inspection.inspector.length);
      this.updateState();
    },
    duplicateItem(index) {
      const duplicate = _.cloneDeep(this.config[this.currentPage].items[index]);
      this.config[this.currentPage].items.push(duplicate);
    },
    openEditPageModal(index) {
      this.editPageIndex = index;
      const pageName = this.config[index].name;
      this.originalPageName = pageName;
      this.editPageName = pageName;
      this.$refs.editPageModal.show();
    },
    editPage(e) {
      if (this.$refs.editPageInput.validator.errorCount) {
        e.preventDefault();
        return;
      }
      this.config[this.editPageIndex].name = this.editPageName;
      this.updateState();
    },
    addPage(e) {
      if (this.$refs.addPageInput.validator.errorCount) {
        e.preventDefault();
        return;
      }
      this.config.push({ name: this.addPageName, items: [] });
      this.currentPage = this.config.length - 1;
      this.addPageName = "";
      this.updateState();
    },
    deletePage() {
      this.config.splice(this.pageDelete, 1);
      this.currentPage = this.pageDelete - 1 >= 0 ? this.pageDelete - 1 : 0;
      this.$store.dispatch("undoRedoModule/pushState", {
        config: JSON.stringify(this.config),
        currentPage: this.currentPage,
        deletedPage: true
      });
    },
    inspect(element = {}) {
      this.inspection = element;
      this.selected = element;
      const defaultAccordion = this.accordions.find(
        (accordion) => this.getInspectorFields(accordion).length > 0
      );
      if (defaultAccordion) {
        this.openAccordion(defaultAccordion);
      }
    },
    // Cloning the control will ensure the config is not a copy of the observable but a plain javascript object
    // This will ensure each control in the editor has it's own config and it's not shared
    cloneControl(control) {
      const copy = {
        config: JSON.parse(JSON.stringify(control.config)),
        inspector: JSON.parse(JSON.stringify(control.inspector)),
        component: control.component,
        "editor-component": control["editor-component"],
        "editor-control": control["editor-control"],
        label: control.label,
        value: control.value
      };
      if (control.component === "FormDatePicker" && copy.config.phrases) {
        copy.config.phrases.ok = this.$t(copy.config.phrases.ok);
        copy.config.phrases.cancel = this.$t(copy.config.phrases.cancel);
      }
      copy.config.label = this.$t(copy.config.label);
      if (Array.isArray(copy.config.options)) {
        for (const io in copy.config.options) {
          copy.config.options[io].content = this.$t(
            copy.config.options[io].content
          );
        }
      }

      // If it's a container, let's add an items property, with the default of items in the control
      if (control.container) {
        copy.items = JSON.parse(JSON.stringify(control.items));
        copy.container = true;
      }

      // Generate Variable Name
      if (
        _.findIndex(control.inspector, keyNameProperty) !== -1 ||
        control.component === "FormLoop") {
        [this.variables, copy.config.name] = this.generator.generate(
          this.config,
          copy["editor-control"] ? copy["editor-control"] : copy.component
        );
        if (_.has(copy, "config.settings.varname")) {
          copy.config.settings.varname = copy.config.name;
        }
      }

      return copy;
    },
    initiateLanguageSupport() {
      if (document.documentElement.lang) {
        this.language = document.documentElement.lang;
      }
      this.collator = Intl.Collator(this.language);
    },
    isAiSection(element) {
      return element.component === "AiSection";
    },
    aiPreview(element) {
      return element.items && element.items[0] && element.items[0].length;
    },
    previewAiChanges(formItems, nonce) {
      this.config.forEach((page, pageKey) => {
        page.items.forEach((item, itemKey) => {
          if (
            item.component === "AiSection" &&
            nonce === item.config.aiConfig.nonce
          ) {
            this.$set(item, "items", JSON.parse(JSON.stringify(formItems)));
          }
        });
      });
    },
    applyAiChanges(element) {
      element.component = "FormMultiColumn";
      element.label = "Multicolumn / Table";
      element["editor-control"] = "MultiColumn";
      element["editor-component"] = "MultiColumn";
      element.inspector = [
        {
          type: "ContainerColumns",
          field: "options",
          config: {
            label: "Column Width",
            validation: "columns-adds-to-12"
          }
        }
      ];
      element.config = {
        icon: "fas fa-table",
        options: [
          {
            value: "1",
            content: "12"
          }
        ]
      };
    },
    updateProgress(progress, nonce) {
      this.config.forEach((page) => {
        page.items.forEach((item) => {
          if (
            item.component === "AiSection" &&
            nonce === item.config.aiConfig.nonce
          ) {
            if (this.cancelledJobs.some((element) => element === nonce)) {
              return;
            }
            this.$set(item.config.aiConfig, "progress", progress);
          }
        });
      });
    },
    addDefaultAiControl() {
      const aiControl = this.builder.controls.find((control) => {
        return control.component === "AiSection";
      });
      const clone = this.cloneControl(aiControl);
      clone.config.aiConfig.autofocus = true;
      clone.config.aiConfig.screenTitle = this.screen.title;
      clone.config.aiConfig.screenDescription = this.screen.description;

      this.config[this.currentPage].items.push(clone);
      this.updateState();
      this.inspect(clone);
    }
  }
};
</script>

<style>
.prevent-interaction {
  pointer-events: none;
}

.svg-icon > svg {
  margin-bottom: 3px;
}
</style>

<style lang="scss" scoped>
$header-bg: #f7f7f7;
$side-bar-font-size: 0.875rem;

.control-icon {
  width: 30px;
  font-size: 20px;

  img {
    height: 20px;
  }
}

.control-item {
  .delete {
    position: absolute;
    top: 0px;
    right: 0px;
    display: none;
  }

  &:hover {
    cursor: move;
  }

  &.selected {
    border-radius: 5px;
    cursor: move;
  }

  &:not(.selected) .card {
    border: none;
  }
}

.hasError {
  border: 1px solid red;
  border-radius: 0.25rem;

  .form-element-header {
    border-bottom: 1px solid red;
    color: red;
  }
}

.inspector-header {
  background: $header-bg;
}

.validation-panel {
  background: $header-bg;
  height: 10rem;
  width: 21.35rem;
  bottom: 3rem;
}

.validation__message {
  text-decoration: none;

  &:hover {
    background: rgba(51, 151, 225, 0.3);
  }
}

.controls-header {
  border-bottom: none;
}

.header-bg {
  background: $header-bg;
}

.controls {
  cursor: move;
  user-select: none;
  font-size: $side-bar-font-size;
}

.header-button {
  height: 38px;
  width: 38px;
}

.filter-icon {
  background-color: #e9ecef;
}

.controls-column {
  max-width: 185px;
}

.inspector-column {
  max-width: 265px;
  font-size: $side-bar-font-size;
}

.form-control-ghost {
  margin-bottom: 0;
  border-radius: 0.25rem;
}

.drag-placeholder {
  width: calc(100% - 2rem);
  height: calc(100% - 6rem);
  top: 4rem;
}
.ai-section-card {
  border-color: #8AB8FF;
}

.ai-section-card .card-header {
  background: #CBDFFF;
}

.ai-control {
  background: #FFF4D3;
}

.pulse {
  animation: pulse-animation 2s infinite;
}

@keyframes pulse-animation {
  0% {
    box-shadow: 0 0 0 0px rgb(28 114 194 / 50%);
  }
  100% {
    box-shadow: 0 0 0 13px rgba(0, 0, 0, 0);
  }
}
</style>
