<template>
    <div :class="classContainer">
        <div class="container-fluid">
            <div class="row">
                <template v-for="(item, index) in items">

                    <draggable :class="classColumn(index)" v-model="items[index]"
                               :options="{group: {name: 'controls'}, handle: '.draggable-handle', animation: 150}" :key="index" >

                        <div class="control-item" :class="{selected: selected === element}"
                             v-for="(element,row) in item" :key="row">

                            <div v-if="element.container">
                                <component :class="elementCssClass(element)" :selected="selected"
                                           @inspect="inspect" v-model="element.items"
                                           v-bind="element.config" :is="element['editor-component']"></component>
                                <button class="delete btn btn-sm btn-danger" @click="deleteItem(index, row)">x</button>
                            </div>

                            <div>
                                <component
                                    :class="elementCssClass(element)"
                                    @inspect="inspect(element)"
                                    :selected="selected === element"
                                    v-bind="element.config"
                                    @labelUpdated="element.config.label = $event"
                                    :is="element['editor-component']">
                                </component>
                                <div v-if="!element.config.interactive" @click.stop="inspect(element)" class="mask highlight draggable-handle"></div>
                                <button class="delete btn btn-sm btn-danger" @click="deleteItem(index, row)">x</button>
                            </div>

                        </div>

                    </draggable>

                </template>
            </div>
        </div>
    </div>
</template>

<script>
    import draggable from "vuedraggable";

    import MultiColumn from "../editor/multi-column";
    import FormText from "../renderer/form-text";
    import FormButton from "../renderer/form-button";
    import FormImage from "../renderer/form-image";
    import HasColorProperty from "../../mixins/HasColorProperty"
    import HtmlEditor from "../editor/html-editor";

    import {
        FormInput,
        FormSelect,
        FormTextArea,
        FormCheckbox,
        FormRadioButtonGroup,
        FormDatePicker
    } from "@processmaker/vue-form-elements/src/components";

    export default {
        name: 'MultiColumn',
        mixins: [HasColorProperty],
        props: ["value", "name", "config", "selected"],
        components: {
            draggable,
            FormInput,
            FormSelect,
            FormTextArea,
            FormCheckbox,
            FormRadioButtonGroup,
            FormText,
            FormButton,
            MultiColumn,
            FormDatePicker,
            FormImage,
            HtmlEditor
        },
        data() {
            return {
                items: []
            };
        },
        watch: {
            value: {
                handler: function () {
                    this.items = this.value;
                },
                immediate: true
            },
            items() {
                this.$emit("input", this.items);
            }
        },
        computed : {
            classContainer() {
                return this.items.length > 0 ? 'form-group': 'column-draggable';
            }
        },
        methods: {
            classColumn(index) {
                let column = 1;
                if (this.items.length < this.config.options.length) {
                    this.items.push([]);
                }
                if (this.config.options[index] && this.config.options[index].content) {
                    column = this.config.options[index].content;
                }
                return 'col-sm-' + column + ' column-draggable';
            },
            inspect(element) {
                this.$emit('inspect', element)
            },
            deleteItem(col, index) {
                // Remove the item from the array in currentPage
                this.items[col].splice(index, 1);
            }
        }
    };
</script>

<style lang="scss" scoped>
    .column-draggable {
        border: 1px dashed #000;
        min-height: 48px;
        content: "Drag Controls";
    }

    .control-item {
        position: relative;

        .delete {
            position: absolute;
            top: 0px;
            right: 0px;
            display: none;
        }

        .highlight {
            border: 1px solid transparent;
        }
        
        &.selected,
        &:hover {
            .highlight {
                border: 1px solid red;
            }
            .delete {
                display: inline-block;
            }
        }
        .mask {
            position: absolute;
            top: 0px;
            left: 0px;
            background-color: rgba(0, 0, 0, 0);
            width: 100%;
            height: 100%;
        }
    }

</style>
